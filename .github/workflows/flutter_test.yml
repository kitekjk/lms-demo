name: Flutter UI Tests

on:
  push:
    branches: [ master ]
    paths:
      - 'lms_mobile_web/**'
  pull_request:
    branches: [ master ]
    paths:
      - 'lms_mobile_web/**'

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        channel: 'stable'

    - name: Get dependencies
      working-directory: ./lms_mobile_web
      run: flutter pub get

    - name: Run analyzer
      working-directory: ./lms_mobile_web
      run: flutter analyze --no-fatal-infos

    - name: Run unit tests (excluding golden tests)
      working-directory: ./lms_mobile_web
      run: flutter test --exclude-tags=golden || echo "No non-golden tests found"

    - name: Run integration tests
      working-directory: ./lms_mobile_web
      run: flutter test integration_test/ || echo "Integration tests failed or none found"

    - name: Check for layout overflow errors
      working-directory: ./lms_mobile_web
      run: |
        flutter test --reporter=json > test_results.json || true
        if grep -q "RenderFlex overflowed" test_results.json; then
          echo "❌ Layout overflow errors detected!"
          exit 1
        else
          echo "✅ No layout overflow errors"
        fi

    - name: Build web
      working-directory: ./lms_mobile_web
      run: flutter build web --release

    - name: Upload test results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: test-results
        path: lms_mobile_web/test_results.json

  visual_regression:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        channel: 'stable'

    - name: Get dependencies
      working-directory: ./lms_mobile_web
      run: flutter pub get

    - name: Run golden tests (informational only)
      working-directory: ./lms_mobile_web
      run: flutter test --update-goldens || true

    - name: Check for golden file changes
      run: |
        if git diff --quiet; then
          echo "✅ No visual changes detected"
        else
          echo "⚠️ Visual changes detected - review golden files"
          git diff --name-only
        fi

    - name: Upload golden files
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: golden-files
        path: lms_mobile_web/test/goldens/
